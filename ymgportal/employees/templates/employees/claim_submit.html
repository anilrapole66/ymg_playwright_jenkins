{% extends 'employees/base.html' %}
{% block content %}
<style>
.container { max-width:1100px; margin-top: 10px; margin-bottom: 20px; padding:0 12px; }
.card { background:#fff; border-radius:12px; padding:26px; box-shadow:0 6px 18px rgba(12,20,43,0.06); }
.title { text-align:center; color:#111111; font-size:22px; font-weight:700; margin-bottom:18px; }
.form-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.form-row { margin-bottom:12px; }
.label { display:block; font-weight:700; color:#111111; margin-bottom:6px; }
.input { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e6eef9; font-size:15px; }
.input:focus, textarea:focus { outline:none; box-shadow:0 0 0 3px rgba(37,99,235,0.12); border-color:#2563eb; }
.full { grid-column:1/-1; }
.hint { color:#6b7280; font-size:13px; margin-top:6px; }
.submit { display:block; width:100%; padding:12px; margin-top:10px; background:#cc1939; color:#fff; border-radius:8px; border:none; font-weight:700; cursor:pointer; }
.submit: hover{ background: linear-gradient(50deg, #2186b7, #3faadd); }
.cancel { display:block; text-align:center; margin-top:12px; color:#cc1939; text-decoration:none; font-weight:600; }
textarea { width:100%; border-radius:8px; border:1px solid #e6eef9; padding:10px 12px; }

/* Dropzone UI */
.dropzone {
    border: 2px dashed #cc1939;
    border-radius: 10px;
    padding: 25px;
    text-align: center;
    color: #cc1939;
    cursor: pointer;
    background: #f8fbff;
    transition: 0.2s;
    margin-top: 8px;
}
.dropzone.dragover {
    background: #e8f1ff;
    border-color: #1e3a8a;
}
.hidden-input {
    display:none;
}
.file-list {
    margin-top: 12px;
    list-style: none;
    padding: 0;
}
.file-list li {
    background: #eef2ff;
    padding: 8px 12px;
    border-radius: 6px;
    margin-bottom: 6px;
    display: flex;
    justify-content: space-between;
}
.file-remove {
    color: red;
    cursor: pointer;
    font-weight: bold;
}
</style>

<div class="container">
  <div class="card">
    <div class="title">Submit New Claim</div>

    <form id="claimForm" method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="form-grid">

        <div class="form-row">
          <label class="label">Start Date</label>
          {{ form.start_date }}
        </div>

        <div class="form-row">
          <label class="label">End Date</label>
          {{ form.end_date }}
        </div>

        <div class="form-row full">
          <label class="label">Description</label>
          {{ form.description }}
        </div>

        <div class="form-row">
          <label class="label">Amount (SGD)</label>
          {{ form.amount }}
        </div>

        <div class="form-row full">
          <label class="label">Upload Receipts</label>

          <!-- Dropzone UI -->
          <div id="dropzone" class="dropzone">
              <p>Drag & drop files here or click to select</p>
              <input id="fileInput" type="file" name="file" multiple class="hidden-input" />
          </div>

          <ul id="fileList" class="file-list"></ul>

          <div class="hint">Allowed: JPG, PNG, PDF • Max: 1MB each</div>
        </div>

      </div>

      <button type="submit" class="submit">Submit Claim</button>
      <a class="cancel" href="{% url 'claim_list' %}" >Cancel</a>
    </form>
  </div>
</div>

<script>
const dropzone = document.getElementById("dropzone");
const fileInput = document.getElementById("fileInput");
const fileList = document.getElementById("fileList");
let selectedFiles = [];

// Open file dialog on click
dropzone.addEventListener("click", () => fileInput.click());

// Visual highlight
dropzone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropzone.classList.add("dragover");
});
dropzone.addEventListener("dragleave", () => {
    dropzone.classList.remove("dragover");
});

// Drop files
dropzone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropzone.classList.remove("dragover");
    handleFiles(e.dataTransfer.files);
});

// Select from file dialog
fileInput.addEventListener("change", () => handleFiles(fileInput.files));

// Add files
function handleFiles(files) {
    for (let file of files) {
        selectedFiles.push(file);
    }
    updateFileList();
}

// Render file list
function updateFileList() {
    fileList.innerHTML = "";
    selectedFiles.forEach((file, index) => {
        let li = document.createElement("li");
        li.innerHTML = `${file.name} <span class="file-remove" onclick="removeFile(${index})">✖</span>`;
        fileList.appendChild(li);
    });
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    updateFileList();
}

// Submit with full validation
document.getElementById("claimForm").addEventListener("submit", function (e) {

    const allowedTypes = ["image/jpeg", "image/png", "application/pdf"];
    const maxSize = 1 * 1024 * 1024;

    // Validate each selected file
    for (const file of selectedFiles) {
        if (!allowedTypes.includes(file.type)) {
            alert(`${file.name} is not allowed.`);
            e.preventDefault();
            return;
        }
        if (file.size > maxSize) {
            alert(`${file.name} exceeds 1 MB.`);
            e.preventDefault();
            return;
        }
    }

    // Append selectedFiles into real form input
    const dt = new DataTransfer();
    selectedFiles.forEach(f => dt.items.add(f));
    fileInput.files = dt.files; // FINAL MAGIC — Sends all files

});
</script>

{% endblock %}
